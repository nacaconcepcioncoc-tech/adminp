{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRES Admin - Orders</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f5f5f5;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 310px;
            background: linear-gradient(180deg, #4a6a82 0%, #3d5773 100%);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0; top: 0;
        }

        .logo-section {
            display: flex; align-items: center;
            padding: 25px 20px; gap: 18px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }

        .logo {
            flex-shrink: 0; width: 55px; height: 55px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.95);
            display: flex; align-items: center; justify-content: center;
        }

        .logo img { width: 50px; height: 50px; border-radius: 50%; object-fit: contain; padding: 5px; }

        .logo-text h1 { font-size: 20px; font-weight: 700; margin-bottom: 4px; letter-spacing: 0.5px; }
        .logo-text p { font-size: 12px; color: #d0dce8; font-weight: 400; }

        .nav-menu { flex: 1; padding: 10px; overflow-y: auto; margin-top: 40px; }

        .nav-item {
            display: flex; align-items: center; gap: 15px;
            padding: 15px 20px; color: #b8c9d9;
            text-decoration: none; border-radius: 8px;
            margin-bottom: 5px; transition: all 0.3s ease; font-size: 15px;
        }
        .nav-item:hover { background-color: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background-color: white; color: #2c4456; }
        .nav-item svg { width: 24px; height: 24px; flex-shrink: 0; }

        .user-profile {
            display: flex; align-items: center; gap: 12px;
            padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto;
        }
        .avatar { width: 42px; height: 42px; background-color: #5d7a8f; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; flex-shrink: 0; }
        .user-info { flex: 1; }
        .user-name { font-size: 14px; font-weight: 600; }
        .logout-icon { width: 24px; height: 24px; color: #b8c9d9; cursor: pointer; transition: color 0.3s; }
        .logout-icon:hover { color: white; }

        .main-content { margin-left: 310px; flex: 1; background-color: #f5f5f5; min-height: 100vh; }

        .header { background: white; padding: 25px 35px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-left svg { width: 24px; height: 24px; color: #333; }
        .header h2 { font-size: 28px; font-weight: 600; color: #1a1a1a; }

        .notification-icon { position: relative; cursor: pointer; padding: 8px; }
        .notification-icon svg { width: 28px; height: 28px; color: #1a1a1a; }
        .notification-badge { position: absolute; top: 2px; right: 2px; background: #ef4444; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; }

        .notification-dropdown { position: absolute; top: 60px; right: 20px; background: white; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 320px; max-height: 400px; overflow-y: auto; z-index: 1000; display: none; }
        .notification-dropdown.show { display: block; }
        .notification-header { padding: 15px; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: #1a1a1a; }
        .notification-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .notification-item:hover { background: #f5f5f5; }
        .notification-item-title { font-weight: 600; color: #1a1a1a; margin-bottom: 4px; }
        .notification-item-text { font-size: 12px; color: #666; }
        .notification-footer { padding: 10px 15px; text-align: center; border-top: 1px solid #e0e0e0; color: #3d5a73; font-size: 13px; font-weight: 600; }

        .orders-content { padding: 30px 35px; padding-bottom: 120px; }
        .orders-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .orders-header h3 { font-size: 24px; font-weight: 600; color: #1a1a1a; }

        .status-filter { position: relative; display: inline-block; }
        .filter-select { appearance: none; padding: 10px 40px 10px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-weight: 500; background: white; color: #374151; cursor: pointer; min-width: 150px; font-family: inherit; }
        .filter-select:focus { outline: none; border-color: #3d5a73; }
        .dropdown-icon { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #6b7280; }

        .table-container { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow: hidden; }
        .orders-table { width: 100%; border-collapse: collapse; }
        .orders-table thead { background: #f9fafb; }
        .orders-table th { text-align: left; padding: 18px 20px; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e5e7eb; }
        .orders-table td { padding: 20px; font-size: 14px; color: #374151; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        .orders-table tbody tr { transition: background 0.2s; }
        .orders-table tbody tr:hover { background: #f9fafb; }
        .orders-table tbody tr:last-child td { border-bottom: none; }

        .order-id { font-weight: 600; color: #1a1a1a; font-size: 13px; }
        .customer-name { font-weight: 600; color: #1a1a1a; }
        .item-name { color: #374151; }
        .order-amount { font-weight: 700; color: #1a1a1a; }

        .status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-badge.pending { background: #fee2e2; color: #dc2626; }
        .status-badge.completed { background: #d1fae5; color: #059669; }

        /* Action buttons */
        .action-cell { display: flex; align-items: center; gap: 8px; }

        .fulfilled-input {
            width: 130px; padding: 5px 9px;
            border: 1.5px solid #e5e7eb; border-radius: 7px;
            font-size: 12.5px; font-family: inherit; color: #374151;
            background: white; transition: border-color 0.2s;
        }
        .fulfilled-input:focus { outline: none; border-color: #3d5a73; background: #f0f4f8; }
        .fulfilled-input::placeholder { color: #c0c8d4; }

        .btn-view-details {
            background: #f0f4f8; color: #3d5a73;
            border: 1.5px solid #d0dce8;
            padding: 6px 14px; border-radius: 7px;
            font-size: 12.5px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            font-family: inherit;
        }
        .btn-view-details:hover { background: #3d5a73; color: white; border-color: #3d5a73; }

        .btn-complete-order {
            background: #fefce8; color: #ca8a04;
            border: 1.5px solid #fde047;
            padding: 6px 12px; border-radius: 7px;
            font-size: 12px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            font-family: inherit;
            display: flex; align-items: center; gap: 5px;
        }
        .btn-complete-order:hover { background: #eab308; color: white; border-color: #eab308; }
        .btn-complete-order.done { background: #d1fae5; color: #059669; cursor: default; border-color: #a7f3d0; }

        .btn-add-order {
            position: fixed; bottom: 30px; right: 30px;
            background: #3d5a73; color: white;
            padding: 14px 28px; border: none; border-radius: 10px;
            font-size: 15px; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100;
            transition: all 0.3s; font-family: inherit;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-add-order:hover { background: #2c4456; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
        .btn-completed-orders {
            position: fixed; bottom: 30px; right: 220px;
            background: #059669; color: white;
            padding: 14px 22px; border: none; border-radius: 10px;
            font-size: 15px; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100;
            transition: all 0.3s; font-family: inherit;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-completed-orders:hover { background: #047857; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
        /* Completed Orders Modal */
        .completed-shell {
            background: white; border-radius: 16px;
            width: 96%; max-width: 900px;
            overflow: hidden;
            box-shadow: 0 24px 60px rgba(0,0,0,0.25);
            animation: slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1);
            max-height: 85vh; display: flex; flex-direction: column;
        }
        .completed-top { background: linear-gradient(135deg,#047857,#059669); padding:22px 26px; display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
        .completed-title { font-family:'DM Serif Display',serif; font-size:20px; color:white; }
        .completed-body { padding:22px 26px; overflow-y:auto; flex:1; }
        .completed-table { width:100%; border-collapse:collapse; }
        .completed-table th { padding:14px 16px; text-align:left; font-size:12px; font-weight:600; color:#6b7280; text-transform:uppercase; letter-spacing:.5px; border-bottom:2px solid #e5e7eb; background:#f9fafb; }
        .completed-table td { padding:14px 16px; font-size:14px; color:#374151; border-bottom:1px solid #f3f4f6; }
        .completed-table tbody tr:hover { background:#f9fafb; }
        .completed-table tbody tr:last-child td { border-bottom:none; }

        /* ‚îÄ‚îÄ MODAL OVERLAY ‚îÄ‚îÄ */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(10,16,26,0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal.show { display: flex; }

        /* ‚îÄ‚îÄ CREATE ORDER MODAL ‚îÄ‚îÄ */
        .modal-shell {
            background: white; border-radius: 20px;
            width: 90%; max-width: 660px;
            overflow: hidden;
            box-shadow: 0 32px 80px rgba(0,0,0,0.3);
            animation: slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1);
            max-height: 90vh; overflow-y: auto;
        }

        @keyframes slideUp { from { opacity:0; transform: translateY(24px) scale(0.97); } to { opacity:1; transform: translateY(0) scale(1); } }

        .modal-top {
            background: linear-gradient(135deg, #2c4456 0%, #3d6680 50%, #4a7a8a 100%);
            padding: 26px 30px 22px; position: relative; overflow: hidden;
        }
        .modal-top::before { content:''; position:absolute; top:-40px; right:-40px; width:160px; height:160px; border-radius:50%; background:rgba(255,255,255,0.06); }
        .modal-top-inner { display:flex; align-items:center; justify-content:space-between; position:relative; z-index:1; }
        .modal-title-group { display:flex; align-items:center; gap:13px; }
        .order-icon { width:42px; height:42px; background:rgba(255,255,255,0.15); border-radius:11px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.2); }
        .order-icon svg { width:20px; height:20px; color:white; }
        .modal-title { font-family:'DM Serif Display',serif; font-size:21px; color:white; }
        .modal-subtitle { font-size:12px; color:rgba(255,255,255,0.6); margin-top:2px; }
        .close-btn { width:32px; height:32px; border-radius:50%; background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2); color:white; font-size:17px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
        .close-btn:hover { background:rgba(255,255,255,0.25); transform:rotate(90deg); }

        .steps-bar { display:flex; align-items:center; margin-top:18px; position:relative; z-index:1; }
        .step { display:flex; align-items:center; gap:7px; flex:1; }
        .step-dot { width:22px; height:22px; border-radius:50%; background:rgba(255,255,255,0.2); border:2px solid rgba(255,255,255,0.3); display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; color:rgba(255,255,255,0.6); flex-shrink:0; }
        .step.active .step-dot { background:white; border-color:white; color:#2c4456; }
        .step-label { font-size:11px; color:rgba(255,255,255,0.5); font-weight:500; }
        .step.active .step-label { color:rgba(255,255,255,0.9); }
        .step-line { flex:1; height:1px; background:rgba(255,255,255,0.2); margin:0 8px; }

        .modal-body { padding:24px 30px; background:#fafafa; }

        .section-label { font-size:10.5px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; color:#9ca3af; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
        .section-label::after { content:''; flex:1; height:1px; background:#e5e7eb; }

        .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:18px; }
        .span-2 { grid-column:span 2; }
        .field { display:flex; flex-direction:column; gap:5px; }
        .field label { font-size:11.5px; font-weight:600; color:#374151; }
        .field label .req { color:#f87171; }

        .input-wrap { position:relative; }
        .input-icon { position:absolute; left:11px; top:50%; transform:translateY(-50%); width:15px; height:15px; color:#9ca3af; pointer-events:none; }
        .input-icon.top { top:13px; transform:none; }

        .field input, .field select, .field textarea {
            width:100%; padding:9px 11px 9px 33px;
            background:white; border:1.5px solid #e5e7eb;
            border-radius:9px; font-size:13px; font-family:'DM Sans',inherit;
            color:#1f2937; transition:all 0.2s; outline:none;
        }
        .field input::placeholder, .field textarea::placeholder { color:#d1d5db; }
        .field input:focus, .field select:focus, .field textarea:focus { border-color:#3d6680; box-shadow:0 0 0 3px rgba(61,102,128,0.1); }
        .field textarea { resize:none; min-height:68px; padding-top:9px; line-height:1.5; }
        .field select { appearance:none; cursor:pointer; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239ca3af' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 10px center; padding-right:28px; }
        .field input.no-icon, .field select.no-icon, .field textarea.no-icon { padding-left:11px; }

        .payment-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:18px; }

        .chip-group { display:flex; gap:7px; flex-wrap:wrap; margin-top:2px; }
        .chip { padding:7px 13px; border-radius:8px; border:1.5px solid #e5e7eb; background:white; font-size:12px; font-weight:500; color:#6b7280; cursor:pointer; transition:all 0.2s; user-select:none; font-family:inherit; }
        .chip:hover { border-color:#3d6680; color:#3d6680; }
        .chip.selected { background:#3d6680; border-color:#3d6680; color:white; }

        .modal-footer { padding:14px 30px 22px; background:#fafafa; border-top:1px solid #f0f0f0; display:flex; align-items:center; justify-content:space-between; }
        .footer-hint { font-size:11px; color:#9ca3af; display:flex; align-items:center; gap:5px; }
        .footer-hint svg { width:12px; height:12px; }
        .btn-group { display:flex; gap:9px; }

        .btn { padding:9px 20px; border-radius:9px; font-size:13px; font-weight:600; font-family:'DM Sans',inherit; cursor:pointer; border:none; transition:all 0.2s; display:flex; align-items:center; gap:6px; }
        .btn-ghost { background:transparent; color:#6b7280; border:1.5px solid #e5e7eb; }
        .btn-ghost:hover { background:#f3f4f6; color:#374151; }
        .btn-primary { background:linear-gradient(135deg,#2c4456,#3d6680); color:white; box-shadow:0 4px 12px rgba(44,68,86,0.25); }
        .btn-primary:hover { transform:translateY(-1px); box-shadow:0 6px 16px rgba(44,68,86,0.35); }
        .btn svg { width:14px; height:14px; }

        .error-banner { display:none; background:#fef2f2; border:1.5px solid #fecaca; border-radius:8px; padding:9px 13px; font-size:12.5px; font-weight:500; color:#dc2626; margin-bottom:14px; align-items:center; gap:7px; }
        .error-banner.show { display:flex; }
        .error-banner svg { width:15px; height:15px; flex-shrink:0; }

        /* ‚îÄ‚îÄ ORDER DETAILS MODAL ‚îÄ‚îÄ */
        .details-shell {
            background:white; border-radius:16px;
            width:90%; max-width:520px;
            overflow:hidden;
            box-shadow:0 24px 60px rgba(0,0,0,0.25);
            animation:slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1);
        }

        .details-top { background:linear-gradient(135deg,#2c4456,#3d6680); padding:22px 26px; display:flex; align-items:center; justify-content:space-between; }
        .details-title { font-family:'DM Serif Display',serif; font-size:19px; color:white; }
        .details-subtitle { font-size:11px; color:rgba(255,255,255,0.6); margin-top:2px; }

        .details-body { padding:22px 26px; }

        .detail-row { display:flex; align-items:flex-start; padding:11px 0; border-bottom:1px solid #f3f4f6; gap:12px; }
        .detail-row:last-child { border-bottom:none; }
        .detail-icon { width:32px; height:32px; background:#f0f4f8; border-radius:8px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .detail-icon svg { width:15px; height:15px; color:#3d5a73; }
        .detail-info { flex:1; }
        .detail-label { font-size:10.5px; font-weight:600; color:#9ca3af; text-transform:uppercase; letter-spacing:0.8px; margin-bottom:2px; }
        .detail-value { font-size:14px; color:#1f2937; font-weight:500; }

        .details-status-row { display:flex; align-items:center; justify-content:space-between; padding:14px 26px; background:#f9fafb; border-top:1px solid #f0f0f0; gap:10px; }

        .status-select-wrap { display:flex; align-items:center; gap:10px; }
        .status-select-wrap label { font-size:12px; font-weight:600; color:#374151; white-space:nowrap; }
        .status-select { padding:7px 28px 7px 10px; border:1.5px solid #e5e7eb; border-radius:8px; font-size:12.5px; font-family:inherit; color:#374151; background:white; cursor:pointer; appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%239ca3af' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 8px center; }
        .status-select:focus { outline:none; border-color:#3d6680; }

        .btn-save-status { padding:7px 16px; background:#3d5a73; color:white; border:none; border-radius:8px; font-size:12.5px; font-weight:600; cursor:pointer; transition:all 0.2s; font-family:inherit; }
        .btn-save-status:hover { background:#2c4456; }

        .details-footer { padding:14px 26px; display:flex; justify-content:flex-end; border-top:1px solid #f0f0f0; }
        .btn-close-details { padding:8px 20px; background:#f3f4f6; color:#374151; border:1.5px solid #e5e7eb; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; transition:all 0.2s; }
        .btn-close-details:hover { background:#e5e7eb; }

        /* scrollbar */
        .nav-menu::-webkit-scrollbar { width:6px; }
        .nav-menu::-webkit-scrollbar-track { background:rgba(255,255,255,0.05); border-radius:10px; }
        .nav-menu::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.2); border-radius:10px; }
        .modal-shell::-webkit-scrollbar { width:5px; }
        .modal-shell::-webkit-scrollbar-thumb { background:#d1d5db; border-radius:10px; }

        @media (max-width:768px) {
            .sidebar { width:80px; }
            .main-content { margin-left:80px; }
            .logo-text, .nav-item span, .user-info { display:none; }
            .logo-section { justify-content:center; padding:20px 10px; }
            .nav-item { justify-content:center; }
            .user-profile { justify-content:center; padding:20px 10px; }
            .orders-content { padding:20px 15px; }
            .form-grid, .payment-row { grid-template-columns:1fr; }
            .span-2 { grid-column:span 1; }
            .steps-bar { display:none; }
        }
    </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
    <div class="logo-section">
        <div class="logo">
            <img src="{% static 'images/logo.png' %}" alt="KRES Logo">
        </div>
        <div class="logo-text">
            <h1>KRES Admin</h1>
            <p>Management Panel</p>
        </div>
    </div>

    <nav class="nav-menu">
        <a href="{% url 'pages:dashboard' %}" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="7" height="7" rx="1" fill="currentColor"/><rect x="14" y="3" width="7" height="7" rx="1" fill="currentColor"/><rect x="3" y="14" width="7" height="7" rx="1" fill="currentColor"/><rect x="14" y="14" width="7" height="7" rx="1" fill="currentColor"/></svg>
            <span>Dashboard</span>
        </a>
        <a href="{% url 'pages:inventory' %}" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none"><path d="M20 7H4C2.9 7 2 7.9 2 9V19C2 20.1 2.9 21 4 21H20C21.1 21 22 20.1 22 19V9C22 7.9 21.1 7 20 7Z" stroke="currentColor" stroke-width="2"/><path d="M12 7V3M8 7V5M16 7V5" stroke="currentColor" stroke-width="2"/></svg>
            <span>Inventory</span>
        </a>
        <a href="{% url 'pages:orders' %}" class="nav-item active">
            <svg viewBox="0 0 24 24" fill="none"><path d="M9 2L7 6H3L8 10L6 14L12 11L18 14L16 10L21 6H17L15 2H9Z" stroke="currentColor" stroke-width="2"/><path d="M6 14L4 22H20L18 14" stroke="currentColor" stroke-width="2"/></svg>
            <span>Orders</span>
        </a>
        <a href="{% url 'pages:customers' %}" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none"><circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2"/><circle cx="17" cy="10" r="3" stroke="currentColor" stroke-width="2"/><path d="M2 20C2 16.5 5 14 9 14C13 14 16 16.5 16 20" stroke="currentColor" stroke-width="2"/><path d="M13 20C13 17.5 15 16 17 16C19 16 22 17.5 22 20" stroke="currentColor" stroke-width="2"/></svg>
            <span>Customers</span>
        </a>
        <a href="{% url 'pages:payments' %}" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none"><rect x="2" y="4" width="20" height="16" rx="2" stroke="currentColor" stroke-width="2"/><path d="M2 10H22M6 14H10M6 17H8" stroke="currentColor" stroke-width="2"/></svg>
            <span>Payments</span>
        </a>
        <a href="{% url 'pages:reports' %}" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/><path d="M8 2V6M16 2V6M3 10H21" stroke="currentColor" stroke-width="2"/><circle cx="8" cy="14" r="1" fill="currentColor"/><circle cx="12" cy="14" r="1" fill="currentColor"/><circle cx="16" cy="14" r="1" fill="currentColor"/><circle cx="8" cy="18" r="1" fill="currentColor"/><circle cx="12" cy="18" r="1" fill="currentColor"/></svg>
            <span>Reports</span>
        </a>
    </nav>

    <div class="user-profile">
        <div class="avatar">A</div>
        <div class="user-info"><div class="user-name">Admin User</div></div>
        <a href="{% url 'pages:logout' %}" onclick="return confirm('Are you sure you want to logout?');" style="text-decoration:none;display:inline-flex;align-items:center;">
            <svg class="logout-icon" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9M16 17L21 12M21 12L16 7M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </a>
    </div>
</div>

<!-- Main Content -->
<div class="main-content">
    <header class="header">
        <div class="header-left">
            <svg viewBox="0 0 24 24" fill="none"><path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <h2>Orders</h2>
        </div>
        <div class="notification-icon" onclick="toggleNotifications(event)">
            <svg viewBox="0 0 24 24" fill="none"><path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 21 3 24 3 24H21C21 24 18 21 18 8Z" fill="currentColor"/><path d="M14.73 21H9.27" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            {% with total=low_stock_count|add:pending_payments|add:new_customers_count %}
                {% if total > 0 %}<span class="notification-badge">{{ total }}</span>{% endif %}
            {% endwith %}
            <div id="notificationDropdown" class="notification-dropdown">
                <div class="notification-header">Notifications</div>
                {% if new_customers_count > 0 %}<a href="{% url 'pages:customers' %}" style="text-decoration:none;color:inherit;"><div class="notification-item" style="position:relative;"><span style="position:absolute;top:8px;right:10px;background:#ef4444;color:white;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;">{{ new_customers_count }}</span><div class="notification-item-title">üë• New Customers</div><div class="notification-item-text">{{ new_customers_count }} new customer(s) today ‚Äî click to view</div></div></a>{% endif %}
                {% if low_stock_count > 0 %}<a href="{% url 'pages:inventory' %}" style="text-decoration:none;color:inherit;"><div class="notification-item"><div class="notification-item-title">‚ö†Ô∏è Low Stock Alert</div><div class="notification-item-text">{{ low_stock_count }} product(s) running low</div></div></a>{% endif %}
                {% if pending_payments > 0 %}<a href="{% url 'pages:payments' %}" style="text-decoration:none;color:inherit;"><div class="notification-item"><div class="notification-item-title">üí≥ Pending Payments</div><div class="notification-item-text">{{ pending_payments }} payment(s) waiting</div></div></a>{% endif %}
                {% with total=low_stock_count|add:pending_payments|add:new_customers_count %}
                    <div class="notification-footer">{% if total == 0 %}No new notifications{% else %}All notifications{% endif %}</div>
                {% endwith %}
            </div>
        </div>
    </header>

    <div class="orders-content">
        <div class="orders-header">
            <h3>All Orders</h3>
            <div class="status-filter">
                <select id="statusFilter" class="filter-select">
                    <option value="all">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="completed">Fully Paid</option>
                </select>
                <svg class="dropdown-icon" width="12" height="12" viewBox="0 0 12 12"><path d="M2 4L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </div>
        </div>

        <div class="table-container">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Order Date</th>
                        <th>Customer</th>
                        <th>Items</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr data-status="{{ order.status }}"
                        data-id="{{ order.order_id }}"
                        data-phone="{{ order.customer_phone }}"
                        data-address="{{ order.customer_address }}"
                        data-notes="{{ order.notes }}"
                        data-date="{{ order.created_at|date:'Y-m-d' }}"
                        data-time="{{ order.created_at|date:'H:i' }}"
                        data-delivery="{{ order.delivery_date|date:'Y-m-d'|default:'-' }}"
                        data-amount="‚Ç± {{ order.total|floatformat:2 }}"
                        data-fulfilled="{{ order.fulfilled_by|default:'' }}"
                        data-payment-status="{% with p=order.payments.first %}{% if p %}{{ p.payment_status }}{% else %}pending{% endif %}{% endwith %}">
                        <td class="order-id">{{ order.order_number }}</td>
                        <td style="font-size:13px;color:#6b7280;">{{ order.created_at|date:"M d, Y" }}</td>
                        <td class="customer-name">{{ order.customer.first_name }} {{ order.customer.last_name }}</td>
                        <td class="item-name">
                            {% for item in order.items.all %}{{ item.product_name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                        </td>
                        <td class="order-amount">‚Ç± {{ order.total|floatformat:2 }}</td>
                        <td>
                            {% if order.status == 'completed' %}
                                <span class="status-badge completed">‚úÖ Fully Paid</span>
                            {% else %}
                                {% with p=order.payments.first %}
                                    {% if p and p.payment_status == 'pending' %}
                                        <span class="status-badge pending">üí∞ Down Payment</span>
                                    {% else %}
                                        <span class="status-badge pending">‚è≥ Pending</span>
                                    {% endif %}
                                {% endwith %}
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-cell">
                                <button class="btn-view-details" onclick="viewOrderDetails('{{ order.order_id }}')">
                                    View Details
                                </button>
                                {% if order.status != 'completed' %}
                                <button class="btn-complete-order" onclick="markCompleted('{{ order.order_id }}', this)" title="Mark as Fully Paid">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                                    Done
                                </button>
                                {% else %}
                                <button class="btn-complete-order done" disabled>
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                                    Completed
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" style="text-align:center;padding:50px;color:#9ca3af;">
                            <div style="font-size:36px;margin-bottom:10px;">üìã</div>
                            <div style="font-size:15px;font-weight:600;margin-bottom:4px;">No orders yet</div>
                            <div style="font-size:13px;">Click "Add New Order" to create the first order.</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <button class="btn-add-order" onclick="openAddOrderModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add New Order
        </button>
        <button class="btn-completed-orders" onclick="openCompletedOrdersModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
            Completed Orders
        </button>
    </div>

    <!-- ‚ïê‚ïê COMPLETED ORDERS MODAL ‚ïê‚ïê -->
    <div id="completedOrdersModal" class="modal">
        <div class="completed-shell">
            <div class="completed-top">
                <div>
                    <div class="completed-title">‚úÖ Completed Orders</div>
                    <div style="font-size:12px;color:rgba(255,255,255,.7);margin-top:3px;">All fully paid & fulfilled orders</div>
                </div>
                <button class="close-btn" onclick="closeCompletedOrdersModal()">&times;</button>
            </div>
            <div class="completed-body">
                <table class="completed-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date Completed</th>
                            <th>Customer</th>
                            <th>Items</th>
                            <th>Amount</th>
                            <th>Fulfilled By</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}{% if order.status == 'completed' %}
                        <tr>
                            <td style="font-weight:600;color:#1a1a1a;font-size:13px;">{{ order.order_number }}</td>
                            <td style="color:#6b7280;font-size:13px;">{{ order.updated_at|date:"M d, Y" }}</td>
                            <td style="font-weight:600;">{{ order.customer.first_name }} {{ order.customer.last_name }}</td>
                            <td>{% for item in order.items.all %}{{ item.product_name }}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
                            <td style="font-weight:700;color:#059669;">‚Ç± {{ order.total|floatformat:2 }}</td>
                            <td>{{ order.fulfilled_by|default:"‚Äî" }}</td>
                        </tr>
                        {% endif %}{% endfor %}
                        {% with any_completed=orders|dictsort:"status" %}
                        {% if not any_completed %}
                        <tr><td colspan="6" style="text-align:center;padding:40px;color:#9ca3af;">
                            <div style="font-size:32px;margin-bottom:8px;">‚úÖ</div>
                            <div style="font-weight:600;">No completed orders yet</div>
                        </td></tr>
                        {% endif %}
                        {% endwith %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- ‚ïê‚ïê CREATE ORDER MODAL ‚ïê‚ïê -->
    <div id="addOrderModal" class="modal">
        <div class="modal-shell">
            <div class="modal-top">
                <div class="modal-top-inner">
                    <div class="modal-title-group">
                        <div class="order-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>
                        </div>
                        <div>
                            <div class="modal-title">New Order</div>
                            <div class="modal-subtitle">Fill in the details to create an order</div>
                        </div>
                    </div>
                    <button class="close-btn" onclick="closeAddOrderModal()">&times;</button>
                </div>
                <div class="steps-bar">
                    <div class="step active"><div class="step-dot">1</div><span class="step-label">Customer</span></div>
                    <div class="step-line"></div>
                    <div class="step"><div class="step-dot">2</div><span class="step-label">Order</span></div>
                    <div class="step-line"></div>
                    <div class="step"><div class="step-dot">3</div><span class="step-label">Payment</span></div>
                </div>
            </div>

            <div class="modal-body">
                <form id="addOrderForm" onsubmit="submitAddOrder(event)">
                    {% csrf_token %}

                    <div class="error-banner" id="formErrorBanner">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                        <span id="errorText">Please fill in all required fields.</span>
                    </div>

                    <div class="section-label">Customer Info</div>
                    <div class="form-grid">
                        <div class="field span-2">
                            <label>Full Name <span class="req">*</span></label>
                            <div class="input-wrap">
                                <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                <input type="text" id="customerName" name="customerName" placeholder="e.g. Maria Santos" required>
                            </div>
                        </div>
                        <div class="field">
                            <label>Contact Number <span class="req">*</span></label>
                            <div class="input-wrap">
                                <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.82 2 2 0 012 .9h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L6.09 8.91a16 16 0 006 6z"/></svg>
                                <input type="tel" id="contactNumber" name="contactNumber" placeholder="09123456789" required>
                            </div>
                        </div>
                        <div class="field">
                            <label>Delivery Date <span class="req">*</span></label>
                            <div class="input-wrap">
                                <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                <input type="date" id="deliveryDate" name="deliveryDate" required>
                            </div>
                        </div>
                        <div class="field span-2">
                            <label>Delivery Address <span class="req">*</span></label>
                            <div class="input-wrap">
                                <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                <input type="text" id="address" name="address" placeholder="123 Rizal St, Cagayan de Oro" required>
                            </div>
                        </div>
                    </div>

                    <div class="section-label">Order Details</div>
                    <div class="form-grid">
                        <div class="field span-2">
                            <label>Product Order <span class="req">*</span></label>
                            <div class="input-wrap">
                                <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>
                                <input type="text" id="orderProduct" name="orderProduct" placeholder="e.g. Rose Bouquet, Sunflower Arrangement" required>
                            </div>
                        </div>
                        <div class="field span-2">
                            <label>Amount (‚Ç±) <span class="req">*</span></label>
                            <div class="input-wrap">
                                <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
                                <input type="number" id="orderAmount" name="orderAmount" placeholder="e.g. 1500" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="field span-2">
                            <label>Fulfilled By</label>
                            <div class="input-wrap">
                                <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                <input type="text" id="fulfilledBy" name="fulfilledBy" placeholder="e.g. Maria (florist on duty)">
                            </div>
                        </div>
                        <div class="field span-2">
                            <label>Note</label>
                            <textarea id="specialRequests" name="specialRequests" class="no-icon" placeholder="Special instructions, pickup time, ribbon color..."></textarea>
                        </div>
                    </div>

                    <div class="section-label">Payment</div>
                    <div class="payment-row">
                        <div class="field">
                            <label>Payment Method <span class="req">*</span></label>
                            <div class="input-wrap">
                                <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                                <select id="paymentMethod" name="paymentMethod" required>
                                    <option value="">Select method</option>
                                    <option value="cash"> Cash</option>
                                    <option value="gcash"> GCash</option>
                                    <option value="bank_transfer"> Bank Transfer</option>
                                </select>
                            </div>
                        </div>
                        <div class="field">
                            <label>Payment Status <span class="req">*</span></label>
                            <div class="chip-group" id="paymentStatusChips">
                                <div class="chip selected" data-value="pending" onclick="selectChip(this)">‚è≥ Pending</div>
                                <div class="chip" data-value="completed" onclick="selectChip(this)">‚úÖ Paid</div>
                            </div>
                            <input type="hidden" id="paymentStatus" name="paymentStatus" value="pending">
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <div class="footer-hint">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    Saved securely to database
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-ghost" onclick="closeAddOrderModal()">Cancel</button>
                    <button type="submit" form="addOrderForm" class="btn btn-primary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                        Create Order
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- ‚ïê‚ïê ORDER DETAILS MODAL ‚ïê‚ïê -->
    <div id="orderDetailsModal" class="modal">
        <div class="details-shell">
            <div class="details-top">
                <div>
                    <div class="details-title">Order Details</div>
                    <div class="details-subtitle" id="detailOrderIdSub">‚Äî</div>
                </div>
                <button class="close-btn" onclick="closeOrderDetailsModal()">&times;</button>
            </div>

            <div class="details-body">
                <div class="detail-row">
                    <div class="detail-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M8 2V6M16 2V6M3 10H21"/></svg></div>
                    <div class="detail-info"><div class="detail-label">Order ID</div><div class="detail-value" id="detailOrderIdValue">‚Äî</div></div>
                </div>
                <div class="detail-row">
                    <div class="detail-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div>
                    <div class="detail-info"><div class="detail-label">Date Created</div><div class="detail-value" id="detailOrderDate">‚Äî</div></div>
                </div>
                <div class="detail-row">
                    <div class="detail-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <div class="detail-info"><div class="detail-label">Customer</div><div class="detail-value" id="detailCustomerName">‚Äî</div></div>
                </div>
                <div class="detail-row">
                    <div class="detail-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.82 2 2 0 012 .9h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L6.09 8.91a16 16 0 006 6z"/></svg></div>
                    <div class="detail-info"><div class="detail-label">Contact</div><div class="detail-value" id="detailContactNumber">‚Äî</div></div>
                </div>
                <div class="detail-row">
                    <div class="detail-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
                    <div class="detail-info"><div class="detail-label">Address</div><div class="detail-value" id="detailAddress">‚Äî</div></div>
                </div>
                <div class="detail-row">
                    <div class="detail-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg></div>
                    <div class="detail-info"><div class="detail-label">Item Ordered</div><div class="detail-value" id="detailOrderItem">‚Äî</div></div>
                </div>
                <div class="detail-row">
                    <div class="detail-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg></div>
                    <div class="detail-info"><div class="detail-label">Amount</div><div class="detail-value" id="detailOrderAmount">‚Äî</div></div>
                </div>
                <div class="detail-row">
                    <div class="detail-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>
                    <div class="detail-info"><div class="detail-label">Delivery Date</div><div class="detail-value" id="detailDeliveryDate">‚Äî</div></div>
                </div>
                <div class="detail-row">
                    <div class="detail-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
                    <div class="detail-info"><div class="detail-label">Note</div><div class="detail-value" id="detailSpecialRequests" style="white-space:pre-wrap;">‚Äî</div></div>
                </div>
                <div class="detail-row">
                    <div class="detail-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <div class="detail-info"><div class="detail-label">Fulfilled By</div><div class="detail-value" id="detailFulfilledBy">‚Äî</div></div>
                </div>
            </div>

            <!-- Update Status -->
            <div class="details-status-row">
                <div class="status-select-wrap">
                    <label>Update Status:</label>
                    <select id="detailStatusSelect" class="status-select">
                        <option value="pending">‚è≥ Pending</option>
                        <option value="completed">‚úÖ Fully Paid</option>
                    </select>
                </div>
                <button class="btn-save-status" onclick="saveOrderStatus()">Save Status</button>
            </div>

            <div class="details-footer">
                <button class="btn-close-details" onclick="closeOrderDetailsModal()">Close</button>
            </div>
        </div>
    </div>

</div><!-- end main-content -->

<script>
// ‚îÄ‚îÄ CSRF ‚îÄ‚îÄ
function getCookie(name) {
    for (const c of document.cookie.split(';')) {
        const t = c.trim();
        if (t.startsWith(name + '=')) return decodeURIComponent(t.slice(name.length + 1));
    }
    return '';
}

// ‚îÄ‚îÄ Modals ‚îÄ‚îÄ
function openAddOrderModal() {
    document.getElementById('addOrderModal').classList.add('show');
    clearFormError();
}

function closeAddOrderModal() {
    document.getElementById('addOrderModal').classList.remove('show');
    document.getElementById('addOrderForm').reset();
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
    const p = document.querySelector('.chip[data-value="pending"]');
    if (p) p.classList.add('selected');
    const s = document.getElementById('paymentStatus');
    if (s) s.value = 'pending';
    clearFormError();
}

function closeOrderDetailsModal() {
    document.getElementById('orderDetailsModal').classList.remove('show');
    window._currentOrderId = null;
}

function openCompletedOrdersModal() {
    document.getElementById('completedOrdersModal').classList.add('show');
}

function closeCompletedOrdersModal() {
    document.getElementById('completedOrdersModal').classList.remove('show');
}

// ‚îÄ‚îÄ Chips ‚îÄ‚îÄ
function selectChip(el) {
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    document.getElementById('paymentStatus').value = el.getAttribute('data-value');
}

// ‚îÄ‚îÄ Error ‚îÄ‚îÄ
function showFormError(msg) {
    const b = document.getElementById('formErrorBanner');
    const t = document.getElementById('errorText');
    if (b && t) { t.textContent = msg; b.classList.add('show'); b.scrollIntoView({behavior:'smooth',block:'nearest'}); }
}
function clearFormError() {
    const b = document.getElementById('formErrorBanner');
    if (b) b.classList.remove('show');
}

// ‚îÄ‚îÄ Submit Create Order ‚îÄ‚îÄ
function submitAddOrder(event) {
    event.preventDefault();
    clearFormError();

    const customerName    = document.getElementById('customerName').value.trim();
    const contactNumber   = document.getElementById('contactNumber').value.trim();
    const address         = document.getElementById('address').value.trim();
    const deliveryDate    = document.getElementById('deliveryDate').value.trim();
    const orderProduct    = document.getElementById('orderProduct').value.trim();
    const orderAmount     = document.getElementById('orderAmount').value.trim();
    const specialRequests = document.getElementById('specialRequests').value.trim();
    const paymentMethod   = document.getElementById('paymentMethod').value;
    const paymentStatus   = document.getElementById('paymentStatus').value;
    const fulfilledBy     = document.getElementById('fulfilledBy').value.trim();

    if (!customerName)  { showFormError('Please enter the customer name.'); return; }
    if (!contactNumber) { showFormError('Please enter a contact number.'); return; }
    if (!address)       { showFormError('Please enter a delivery address.'); return; }
    if (!orderProduct)  { showFormError('Please enter the product order.'); return; }
    if (!orderAmount)   { showFormError('Please enter the order amount.'); return; }
    if (!deliveryDate)  { showFormError('Please select a delivery date.'); return; }
    if (!paymentMethod) { showFormError('Please select a payment method.'); return; }
    if (!paymentStatus) { showFormError('Please select a payment status.'); return; }

    const nameParts = customerName.split(/\s+/);
    const firstName = nameParts[0];
    const lastName  = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';
    const autoEmail = 'customer_' + contactNumber.replace(/\D/g,'') + '_' + Date.now() + '@kres.local';

    const payload = {
        customer_email:      autoEmail,
        customer_first_name: firstName,
        customer_last_name:  lastName,
        customer_phone:      contactNumber,
        customer_address:    address,
        items: [{ product_name: orderProduct, quantity: 1, unit_price: parseFloat(orderAmount) || 0 }],
        notes:          specialRequests,
        payment_method: paymentMethod,
        payment_status: paymentStatus,
        delivery_date:  deliveryDate,
        fulfilled_by:   fulfilledBy,
        tax: 0, discount: 0
    };

    const btn = document.querySelector('button[form="addOrderForm"]');
    const origHTML = btn.innerHTML;
    btn.innerHTML = '‚è≥ Creating...';
    btn.disabled = true;

    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken');

    fetch('/ajax/order/create/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
        body: JSON.stringify(payload)
    })
    .then(r => { if (!r.ok) throw new Error('Server error ' + r.status); return r.json(); })
    .then(data => {
        btn.innerHTML = origHTML;
        btn.disabled = false;
        if (data.success) {
            btn.innerHTML = '‚úì Created!';
            btn.style.background = 'linear-gradient(135deg,#059669,#10b981)';
            setTimeout(() => location.reload(), 1200);
        } else {
            showFormError(data.message || 'Failed to create order.');
        }
    })
    .catch(err => {
        btn.innerHTML = origHTML;
        btn.disabled = false;
        showFormError('Could not reach server: ' + err.message);
    });
}

// ‚îÄ‚îÄ View Order Details ‚îÄ‚îÄ
function viewOrderDetails(orderId) {
    const row = document.querySelector('tr[data-id="' + orderId + '"]');
    if (!row) return;

    window._currentOrderId = orderId;

    const orderNum = row.querySelector('.order-id').textContent.trim();
    const rawDate  = row.getAttribute('data-date') || '';
    const rawTime  = row.getAttribute('data-time') || '';

    document.getElementById('detailOrderIdSub').textContent    = orderNum;
    document.getElementById('detailOrderIdValue').textContent  = orderNum;
    document.getElementById('detailOrderDate').textContent     = rawDate + (rawTime ? ' at ' + rawTime : '');
    document.getElementById('detailCustomerName').textContent  = row.querySelector('.customer-name').textContent.trim();
    document.getElementById('detailContactNumber').textContent = row.getAttribute('data-phone') || '‚Äî';
    document.getElementById('detailAddress').textContent       = row.getAttribute('data-address') || '‚Äî';
    document.getElementById('detailOrderItem').textContent     = row.querySelector('.item-name').textContent.trim();
    document.getElementById('detailOrderAmount').textContent   = row.getAttribute('data-amount') || row.querySelector('.order-amount').textContent.trim();
    document.getElementById('detailDeliveryDate').textContent  = row.getAttribute('data-delivery') || '‚Äî';
    document.getElementById('detailSpecialRequests').textContent = row.getAttribute('data-notes') || 'None';
    document.getElementById('detailFulfilledBy').textContent   = row.getAttribute('data-fulfilled') || '‚Äî';

    // Set current status in dropdown
    const currentStatus = row.getAttribute('data-status') || 'pending';
    document.getElementById('detailStatusSelect').value = currentStatus;

    document.getElementById('orderDetailsModal').classList.add('show');
}

// ‚îÄ‚îÄ Save Status from Details Modal ‚îÄ‚îÄ
function saveOrderStatus() {
    const orderId   = window._currentOrderId;
    const newStatus = document.getElementById('detailStatusSelect').value;
    if (!orderId) return;

    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken');
    const btn  = document.querySelector('.btn-save-status');
    btn.textContent = 'Saving...';
    btn.disabled = true;

    fetch('/ajax/order/update-status/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
        body: JSON.stringify({ order_id: orderId, status: newStatus })
    })
    .then(r => r.json())
    .then(data => {
        btn.textContent = 'Save Status';
        btn.disabled = false;
        if (data.success) {
            closeOrderDetailsModal();
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(() => { btn.textContent = 'Save Status'; btn.disabled = false; });
}

// ‚îÄ‚îÄ Save Fulfilled By ‚îÄ‚îÄ
function saveFulfilledBy(orderId, name) {
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken');
    fetch('/ajax/order/update-fulfilled/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
        body: JSON.stringify({ order_id: orderId, fulfilled_by: name })
    }).catch(() => {});
}

// ‚îÄ‚îÄ Mark Completed from table row ‚îÄ‚îÄ
function markCompleted(orderId, btnEl) {
    if (!confirm('Mark this order as Completed?')) return;

    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken');
    btnEl.textContent = '...';
    btnEl.disabled = true;

    fetch('/ajax/order/update-status/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
        body: JSON.stringify({ order_id: orderId, status: 'completed' })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
        else { btnEl.textContent = 'Done'; btnEl.disabled = false; alert('Error: ' + data.message); }
    })
    .catch(() => { btnEl.textContent = 'Done'; btnEl.disabled = false; });
}

// ‚îÄ‚îÄ Notifications ‚îÄ‚îÄ
function toggleNotifications(event) {
    event.stopPropagation();
    document.getElementById('notificationDropdown').classList.toggle('show');
}
document.addEventListener('click', function(e) {
    const icon = document.querySelector('.notification-icon');
    if (icon && !icon.contains(e.target)) document.getElementById('notificationDropdown').classList.remove('show');
});

// ‚îÄ‚îÄ Status Filter ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('statusFilter').addEventListener('change', function() {
        const sel = this.value.toLowerCase();
        document.querySelectorAll('.orders-table tbody tr').forEach(row => {
            const s = row.getAttribute('data-status');
            row.style.display = (sel === 'all' || s === sel) ? '' : 'none';
        });
    });

    const filter = sessionStorage.getItem('orderFilter');
    if (filter) {
        document.querySelectorAll('.orders-table tbody tr').forEach(row => {
            const badge = row.querySelector('.status-badge');
            const s = badge ? badge.textContent.trim().toLowerCase() : '';
            row.style.display = (s === filter) ? '' : 'none';
        });
        window.addEventListener('beforeunload', () => sessionStorage.removeItem('orderFilter'));
    }
});

// ‚îÄ‚îÄ Close on backdrop click ‚îÄ‚îÄ
window.addEventListener('click', function(e) {
    if (e.target === document.getElementById('addOrderModal'))        closeAddOrderModal();
    if (e.target === document.getElementById('orderDetailsModal'))    closeOrderDetailsModal();
    if (e.target === document.getElementById('completedOrdersModal')) closeCompletedOrdersModal();
});
</script>
</body>
</html>